

    phina.globalize();

    var ASSETS = {
      image: {
        'tomapiko': 'tomapiko_ss.png',
        'mikarin': 'mikachan_ss.png',
        'takenokohiyoko':'takenokohiyoko_ss.png',
        'ground' : 'Faithful-texture-pack-1-2.png',
        'ball' : 'ball.png'
      },
      sound: {
        'jump': 'data:audio/x-m4a;base64,AAAAHGZ0eXBNNEEgAAAAAE00QSBtcDQyaXNvbQAAA2ptb292AAAAbG12aGQAAAAAth9I0bYfSNEAAKxEAAA4AAABAAABAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAAB/HRyYWsAAABcdGtoZAAAAAG2H0jRth9I0QAAAAEAAAAAAAA4AAAAAAAAAAAAAAAAAAEAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAZhtZGlhAAAAIG1kaGQAAAAAth9I0bYfSNEAAKxEAAA4AAAAAAAAAAAiaGRscgAAAAAAAAAAc291bgAAAAAAAAAAAAAAAAAAAAABTm1pbmYAAAAQc21oZAAAAAAAAAAAAAAAJGRpbmYAAAAcZHJlZgAAAAAAAAABAAAADHVybCAAAAABAAABEnN0YmwAAAB2c3RzZAAAAAAAAAABAAAAZm1wNGEAAAAAAAAAAQAAAAAAAAAAAAIAEAAAAACsRAAAAAAAM2VzZHMAAAAAA4CAgCIAAAAEgICAFEAVABgAAAAAAAAA+gAFgICAAhIIBoCAgAECAAAAD3NidGQAAAAASTE2AAAAGHN0dHMAAAAAAAAAAQAAAA4AAAQAAAAAHHN0c2MAAAAAAAAAAQAAAAEAAAAOAAAAAQAAAExzdHN6AAAAAAAAAAAAAAAOAAAABAAAALYAAADwAAABAAAAASoAAADJAAAAwAAAAL8AAADIAAAAxwAAAMQAAAD0AAAAmAAAACsAAAAUc3RjbwAAAAAAAAABAAAQAAAAAPp1ZHRhAAAA8m1ldGEAAAAAAAAAImhkbHIAAAAAAAAAAG1kaXJhcHBsAAAAAAAAAAAAAAAAAMRpbHN0AAAAvC0tLS0AAAAcbWVhbgAAAABjb20uYXBwbGUuaVR1bmVzAAAAFG5hbWUAAAAAaVR1blNNUEIAAACEZGF0YQAAAAEAAAAAIDAwMDAwMDAwIDAwMDAwODQwIDAwMDAwMzlDIDAwMDAwMDAwMDAwMDJDMjQgMDAwMDAwMDAgMDAwMDAwMDAgMDAwMDAwMDAgMDAwMDAwMDAgMDAwMDAwMDAgMDAwMDAwMDAgMDAwMDAwMDAgMDAwMDAwMDAAAAxyZnJlZQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAoubWRhdADQQAcBApnIPbtcUlMJMRipw9/7X/M0y2v6ef/rn+9/r89D11/b9P3+PwBDqwN5eFSViEKWTQ0hEmbjypAITUcbkAB7f7B9/xzF/4MPygL+5U64bjM7SBzkm8M1HH2SGIRnA5x7P2uuJ5BCKLxgssFcLqLZ3FevPRr0F3CMT8hIpKv1/iCo84AHN04lIjwd9kfpgpvrRGSrJx66pB0UmcpyS5zIgZ/2F7mWnBaH8R0XWUXGotLa8kD34AEymT7cNCVuIxsJmTZIn8/x/x1+vToe79tePb6dax/T5/0/etzPgBsl0jTcJnog3BkMNCKTbr+5r0p4bc/sDeOY+7qyx0X3+gCp+xD4lT2RQcUW6PHjdb9dKqFg1ihiN0qJ0zkRmdKylaUWinNAsGLCtgnzVnzFfCagGkDCZVB2abPPcOsXMVAyIxAHmwnz+2ONbmbxLURmjfRJlxKbcIPQULNNRrsDDrEiEmAKVTF34xCNa/SV2mG4jACiWQoIRN3kQSh4QjXbI6spXAoIS5v+F2NNo7eAswHenljcvnriV9oy7p/wdJTgAum92sLfgAEemX7bQUTtIrUE2qf0/nqH2dGf215+OL+ZXwQHW8qT3OO8uSK1VbzV1dwE46/TmNW82Dx4Hpla7VX9663Ny0qi9rECFyTXRLg0Czy8f2qEJpdHWt1C0DrTjSuU8687eG+pbR/MtwJ7/fQJNI68I/RnQchTsKNDfVXepBs6812VmYos8KIKdGKLprTJZ4DDRhhVBeYjKbRa86iQlk0AINnXZFdxkqIkiyCzOAGFwoBuUL/Hsqn5pb2c50YTyWsU6Wvy5Zc9yNfx3TMZVJgMKe8TtbLjunUdjqu4qxWK4F7tVdFZ392s9+q3McTMs3svhqWzvu5xkjKt6Mc9/28ew4ABIJky2ymE7rRHahJzeTWoqV/x/jT+nt9DWv/H+VfPft1n0f9K/meaywz+ntx0oG/6V/n2ncCdbZABHWuQfDzk1L4Zz75t17oppOM4QjWM3GcHjlef9Ob+l4Y+/cDjzBho7azMcwnUU4xA+HlHe7g3iEjfkArAtok1lQYCctPiX1H4rj3h248L48krVmQM5uhO49orogwLtegS+6UKeOqAHx6xysF7lkL192jO0Bry75i3lQvmE+CSuimP/rzbc1R7ocwvwxobudLo/V2nmrtQ7aePhCaqkxH3BxrZQ7AYJQTonC8RLvK7y6GvvEf1dCDY/qeS2hm8rDGm/N/EwwtofVaBeJFa1di8T8uubGygLcxtsZSWTITi1UNC3BIU9XaveE5ARrCE3i/AASjVrUzEKYySJEK7bfPfOC8XNWnF35BIyCwRoH9hoEP8/VnrfwFvh+Q5bvrPva3gvO3emPxkDz+rNV/8rm7ca167uGOMOPX5v38MZmbdt0wJA4YV9vdIeM/avhu6ce3wwpc7TIyMgbvWZwVzFcQPbAGB/w8/YAAAAAKjDw92g1WdPkbPJtn0H2rLltIKIGwz+rwwvnxOxQE7A+IGBD9qibw4yTxIxE6VjlxX89tKdVmp/tveILDBOqbEWMIiNLKKZYK1rx6LMsQOASAVrExrGYmOo0IISSJjbuet14Jr1els6NuHxoICnAqSHf0MFyu18aaHydHZy5E7e/5e39ofZNUfq4J4VfvksKMQlvkx0MYMbNTMDFgKENOMYxIxiRjv39X3WyiSkuW7UdGqCmoQUFBQUF/4v/F+KmogrwgZg7iMmTM07zeplqxPirpfdsDOCYRDz5dnUgYq7bJe0C6ZzCBYzLxlD79qQ/5GeWtIqlWNVJ4ILznGPH9leUucWcknRLc8kapYvUBwARQVrCybIxUOThG8Kjt385vznLhadLuLAQpmoMAy7hum7vvqi2O2iotOUkz9cJwlveq848D7Ifv9/H4Pv/1PR8PblMVzqCO7yDTNbbMemMs4JHmEpC1dioWtHpPgBF7qzlSYsPupK5FuikIlvPfgSQpJ5TwHmW11KL2RZU2z9pjm2/bGwtEo/NQe5RQ1BY+a+tifT+10rSTFHW6g4OpFRumRZoTlazfTKYdhaQkEwJsjB9NoxDAAcXW6mPPK4HABGBWsNQIMEJgpeJXDt6Z79tHft00vVgRSAgsW1SUtPUoWs7HqzSc6xv/D8w/oLE6sOWTt/5COT4To2SgSmtFHZKj4XYmalkCPBbRWHaJfGeUnenMtWttxbvYVOvsJlN9AhMsBAzqxUuxlp0tduT4hdhl4UdzsWa0zrQyQYgW3j09a0HsdcOxOgkWmzw22j0dP8UqBmzJxlczG4qaDlilklaeSN5PISvTwwS5/ZHLDsnDJ2xTzOr9OniGKOCHkiWw1yysq73tEDgEeFakWUgwNiIIQoIioEiiZIp32dmrY0k06lC2IUBcpdr8uyym0C+tm0uuwpqzLq6pmTd6MSI2X3/2M0WQ+H8wqCdKpHzp6xzUmhhudzZd1XMixOaELFTatEjYa9nks8LZNNDRUIo9ZbgDIFpXaD0uzsLastI94EqsyM5g/Wyx5uVWw+N86yk+87bFlEqKm4MTQaz2zvVSzM1ZEppAbNSqb4/KghK1i8S2NP1LCdWC+JiIRfa7T5I7C1rVluhh0JyCW6engAcABAhWsMJsiEYpDMJFQgnZIfLv8t3OrX9LNkFAqG+glS9egZHrY5d5ve6+4fUjMv1h8nwmTg9t3aTs/XnFmKSA34upPCcQ04unDAGDtBkfDpGecMKK4yEz3M8TKBwwBTJaNdsJokOLqoYcjnP4D67Sq1J1Zk63OcK7OralT2jmtoL6j4PbSz3N+Nw7iLwq0xgFqaxB2mWRcEEUx2d1iViKjdgera+Q1uSySOgs3En3lwUTQnFWWnHKlcNgD2et3mtb17AOAAQQVrrAkETxGbkPtzt4PZq9eZ250AIhRYomzVMeR3D3Ni+i9ho3rcH5D+hGEEOTe40Bxzm3thvVOpc0/A+i0t2V0jjLz6oJkHghOycvbcY0S7nz+x4ZAtU5m4fzB9/7UyuH0aVBEwAzUQCGiDZ3YTWWgw5MIQOsg1hByiB0kCgwAPyHabDI4rgETAsxUt0+WMuF2VsvqRJKnBs6X+bdJla5/ae9Gz1gVOvW/C3mPAl+FKJ+htz8M5Qy85glEzrZLbCJYO9dgUs75KQA6N7r3MkRQgIEEjhsk7TUM/Pahik+3vbWKJhueONh2mA23Y02z6SWiBwEKFamEOBMUXAYQqed59lcttNJ1nF3rosyg9LlVIiGQ/4C9pjBzLVSSAKmkrEMUiTgflfbvHILa2WdjRLN8Z3HXHzqPKqu6pkUGyGho7W9osj4YduDu7u7u7u/8BjRNeNk/hgtkp+mLERGOtfhPyU2U7Rh1/t9Lft+G9gNeNTfha9YSSDXry7I01QtNlTRwiGrrryz8kQOAAQIVhJSA+B500MSlyrhYVDwAB815rOVLaRosDbLPGU+iprDZq7UoNgrWcA=='
      },
    };

    phina.define('MainScene', {
      superClass: 'CanvasScene',

      init: function(options) {
        this.superInit(options);

        var that = this;

        this.backgroundColor = 'lightgray';
        this.backgroundLayer = DisplayElement().addChildTo(this);
        this.toyLayer = DisplayElement().addChildTo(this);
        this.mainLayer = DisplayElement().addChildTo(this);
        this.UILayer = DisplayElement().addChildTo(this);

        this.backgroundState = [];

        this.cellXNum = (this.width/32).toFixed();
        this.cellYNum = (this.height/32).toFixed();

        for(var y = 0; y < this.cellYNum; ++y)
        {
          for(var x = 0; x < this.cellXNum; ++x)
          {
            var i = y * this.cellXNum + x;
            this.backgroundState[i] = Sprite('ground', 32, 32).addChildTo(this.backgroundLayer);
            this.backgroundState[i].frameIndex = 0;
            this.backgroundState[i].x = 32 * x + 16;
            this.backgroundState[i].y = 32 * y + 16;
          }
        }

        var imageNames = ['tomapiko', 'mikarin', 'takenokohiyoko'];
        var team = Math.floor( Math.random() * 3 );
        var imageName = imageNames[team];

        this.player = Player(imageName, 64, 64).addChildTo(this.mainLayer);
        this.player.team = team;
        this.player.posX = Math.random() * this.width;
        this.player.posY = Math.random() * this.height;
        this.player.width = 64;
        this.player.height = 64;
        this.player.mainScene = this;

        this.mainLayer.enemyGroup = [];

        var mainLayer = this.mainLayer;

        var setEnemyMembers = function(enemy, snapshotValue)
        {
          enemy.targetX = snapshotValue.object.x;
          enemy.targetY = snapshotValue.object.y;
          enemy.frameIndex = snapshotValue.object.frameIndex;
          enemy.startJumping = snapshotValue.object.startJumping;
          enemy.state = snapshotValue.object.state;
          enemy.team = snapshotValue.object.team;
          enemy.user = snapshotValue.user;
          enemy.isArrivingData = true;
        };

        firebaseRefGame.child('players').on('child_added', function (snapshot) {
          if (snapshot.key() !== myPlayer.key())
          {
            var imageName = imageNames[snapshot.val().object.team];
            var enemy = Enemy(imageName).addChildTo(mainLayer);
            setEnemyMembers(enemy, snapshot.val());
            mainLayer.enemyGroup[snapshot.key()] = enemy;
          }
          else
          {

          }
        });

        firebaseRefGame.child('players').on('child_changed', function (snapshot) {
          if (snapshot.key() !== myPlayer.key())
          {
            var enemy = mainLayer.enemyGroup[snapshot.key()];
            setEnemyMembers(enemy, snapshot.val());
          }
          else
          {

          }
        });

        firebaseRefGame.child('players').on('child_removed', function (snapshot) {
          if (snapshot.key() !== myPlayer.key()) {
            var enemy = mainLayer.enemyGroup[snapshot.key()];
            enemy.remove();
            delete mainLayer.enemyGroup[snapshot.key()];
          }
        });

        var backgroundState = this.backgroundState;
        var cellWidth = this.cellXNum;
        var cellHeight = this.cellYNum;

        var drawPixel = function(snapshot)
        {
          var pos = snapshot.key().split(":");
          backgroundState[Number(pos[1] * cellWidth) + Number(pos[0])].frameIndex = snapshot.val();
        };

        var clearPixel = function(snapshot)
        {
          var pos = snapshot.key().split(":");
          backgroundState[Number(pos[1] * cellWidth) + Number(pos[0])].frameIndex = 0;
        };

        firebaseRefGame.child('background').on('child_added', drawPixel);
        firebaseRefGame.child('background').on('child_changed', drawPixel);
        firebaseRefGame.child('background').on('child_removed', clearPixel)

        this.ball = Ball().addChildTo(this.UILayer);
        this.ball.x = this.gridX.center();
        this.ball.preX = this.ball.x;
        this.ball.y = this.gridY.center();
        this.ball.preY = this.ball.y;
        var ball = this.ball;

        var moveBall = function(snapshot)
        {
          ball.targetX = snapshot.val().x;
          ball.targetY = snapshot.val().y;
        };

        firebaseRefGame.child('ball').on('child_added', moveBall);
        firebaseRefGame.child('ball').on('child_changed', moveBall);


        var rect = RectangleShape().addChildTo(this.UILayer);
        rect.x = this.gridX.center();
        rect.y = this.gridY.center(7);
        rect.width = this.width * 0.9;
        rect.height = this.height * 0.06;
        rect.fill = "rgba(255, 255, 255, 0.4)";
        rect.stroke = "rgba(255, 255, 255, 0.4)";

        this.input = document.querySelector('#input');
        input.oninput = function() {
          label.text = input.value + '|';
        };
        input.onfocus = function()
        {
            label.text = '|';
        }
        input.onblur = function()
        {
            label.text = '';
        }


        var label = Label('').addChildTo(this.UILayer);
        label.x = rect.x;
        label.y = rect.y;
        label.fill = "black";
        label.fontSize = 24;
        label.clear = function()
        {
          input.value = '';
          this.text = '';
        }
        rect.setInteractive(true);
        rect.onclick = function() {
          input.focus();
        };

        this.inputLabel = label;

        firebaseRefGame.child('messages').endAt().limit(1).on('child_added', function (snapshot)
        {
          var data = snapshot.val();
          var key = data.key || "anonymous";
          var message = data.text;

          if ( key == myPlayer.key() )
          {
            var c = ComboLabel(message).addChildTo(that.player);
          }
          else
          {
              var enemy = mainLayer.enemyGroup[key];
              var c = ComboLabel(message).addChildTo(enemy);
          }
        });
      },
      update: function(app)
      {

      },
      onkeydown: function(e)
      {
        if(e.keyCode == 13)
        {
          if(this.inputLabel.text != '')
          {
            firebaseRefGame.child('messages').push({key:myPlayer.key(), text:this.input.value});
            this.inputLabel.clear();
          }
        }
        this.player.onkeydown(e);
      },
      onpointstay: function(app)
      {

      },
    });

    phina.define(
      'Player', {
        superClass: 'Sprite',
        init: function(image)
        {
          this.superInit(image);
          this.jumpHeight = 0.0;
          this.jumpSpeed = 0.0;
          this.isJumping = false
          this.posX = 0.0;
          this.prePosX = 0.0;
          this.preX = 0.0;
          this.posY = 0.0;
          this.prePosY = 0.0;
          this.preY = 0.0;
          this.vx = 0.0;
          this.vy = 0.0;
          this.preVx = 0.0;
          this.preVy = 0.0;

          this.state = 0;
          this.preState = 0;
          this.preFrameIndex = this.frameIndex;
          this.tFrameIndex = this.frameIndex;
          this.startJumping = false;
          this.keyFrame = 0;
          this.indexArray = [0,1,2,1];
          this.mainScene = null;

          /*
          this.label = Label(currentPlayer.name).addChildTo(this);
          var posX = this.posX;
          var posY = this.posY;
          this.label.fontSize = 30;
          this.label.update = function()
          {
            this.x = posX;
            this.y = posY + 45;
          };
          */

          this.jumpSound = AssetManager.get('sound', 'jump');
          this.jumpSound.volume = 0.01;

          this.rect = RectangleShape();
          this.rect.width = 24;
          this.rect.height = 24;
        },
        update: function(app)
        {
          var keyboard = app.keyboard;
          //this.label.text = this.state;
          this.frameIndex = this.tFrameIndex;

          this.vx = 0.0;
          this.vy = 0.0;
          if (keyboard.getKey('left'))
          {
            this.vx = -4;
            this.frameIndex = 12 + this.indexArray[(this.keyFrame/3).toFixed() % 4];
            this.tFrameIndex = 0;
          }
          if (keyboard.getKey('right'))
          {
            this.vx = 4;
            this.frameIndex = 15 + this.indexArray[(this.keyFrame/3).toFixed() % 4];
            this.tFrameIndex = 1;
          }

          if (keyboard.getKey('up'))
          {
            this.vy = -4;
            this.frameIndex = 9 + this.indexArray[(this.keyFrame/3).toFixed() % 4];
            this.tFrameIndex = 10;
          }
          if (keyboard.getKey('down'))
          {
            this.vy = 4;
            this.frameIndex = 6 + this.indexArray[(this.keyFrame/3).toFixed() % 4];
            this.tFrameIndex = 7;
          }
          if(keyboard.getKey('ctrl'))
          {
            this.tFrameIndex = this.frameIndex;
            this.frameIndex = 5;
          }


          this.startJumping = false;
          if(!this.isJumping)
          {
            if(keyboard.getKeyDown('space'))
            {
              this.jumpHeight;
              this.isJumping = true;
              this.jumpSpeed = 10.0;
              this.jumpSound.play();
              this.startJumping = true;
            }
          }
          else
          {
            this.jumpSpeed -= 1.0;
            this.jumpHeight += this.jumpSpeed;
            if(this.jumpHeight < 0.0)
            {
              this.jumpHeight = 0.0;
              this.isJumping = false;
            }
          }

          //hit
          this.mainScene.backgroundLayer.children.each(function(child)
        {
            var tx = this.posX + this.vx;
            var ty = this.posY + this.vy;
            var dx = tx - child.x;
            var dy = ty - child.y;
            this.rect.x = tx;
            this.rect.y = ty + 10;

            if (child.frameIndex == 7 && child.hitTestElement(this.rect))
            {
              this.vx = 0;
              this.vy = 0;
            }
          }, this);

          this.mainScene.backgroundLayer.children.each(function(child)
        {
          var tx = this.posX + this.vx;
          var ty = this.posY + this.vy;
          var dx = tx - child.x;
          var dy = ty - child.y;
          this.rect.x = tx;
          this.rect.y = ty + 10;

          if (child.frameIndex == 7 && child.hitTestElement(this.rect))
          {
          if(dy < dx && dy > -dx)
          {
            this.posX = child.x + this.rect.width + 2;
          }
          if(dy > dx && dy > -dx)
          {
            this.posY = child.y + this.rect.height - 10 + 2;
          }
          if(dy > dx && dy < -dx)
          {
            this.posX = child.x - this.rect.width - 2;
          }
          if(dy < dx && dy < -dx)
          {
            this.posY = child.y - this.rect.height - 10 - 2;
          }
        }
        }, this);

          this.posX += this.vx;
          this.posY += this.vy;
          this.posX = Math.min(Math.max((this.posX).toFixed(), -64), 640 + 64 );
          this.posY = Math.min(Math.max((this.posY).toFixed(), -64), 480 + 64 );

          this.x = this.posX;
          this.y = this.posY - this.jumpHeight;
          // Write new ship location to Firebase on each key frame
          if (
            (this.x !== this.preX)
          || (this.y !== this.preY)
          || (this.state !== this.preState)
          || (this.frameIndex !== this.preFrameIndex)
          || (this.vx !== this.preVx)
          || (this.vy !== this.preVy)
          || this.startJumping
        ) {
            myPlayer.set({
              object: {
                x: this.x,
                y: this.y,
                frameIndex: this.frameIndex,
                startJumping: this.startJumping,
                state: this.state,
                team: this.team,
              },
              user: currentPlayer
            });
          }
          this.prePosX = this.posX;
          this.prePosY = this.posY;
          this.preX = this.x;
          this.preY = this.y;
          this.preState = this.state;
          this.preFrameIndex = this.frameIndex;
          this.preVx = this.vx;
          this.preVy = this.vy;
          this.keyFrame++;
          if (this.keyFrame % 60 == 0) {
            myPlayer.set({
              object: {
                x: this.x,
                y: this.y,
                frameIndex: this.frameIndex,
                startJumping: this.startJumping,
                state: this.state,
                team: this.team,
              },
              user: currentPlayer
            });
          }
        },
      onkeydown: function(e)
      {
        if(e.keyCode >= 48 && e.keyCode <= 126 )
        {
          var ch = String.fromCharCode(e.keyCode);
          this.state = ch;
        }

      }});

      phina.define('Enemy', {
        superClass: 'Sprite',
        init: function(imageName) {
          this.superInit(imageName, 64, 64);
          this.width = 64;
          this.height = 64;

          this.user = "anyone";
          this.fref = null;
          this.state = 0;
          this.targetX = 0.0;
          this.targetY = 0.0;
          this.isArrivingData = false;
          this.preX = 0.0;
          this.preY = 0.0;
          this.vx = 0.0;
          this.vy = 0.0;
          this.team;


          this.jumpSound = AssetManager.get('sound', 'jump');
          this.jumpSound.volume = 0.01;
        },
        update: function() {
          //this.label.text = this.state;
          if(this.startJumping)
          {
            this.jumpSound.play();
            this.startJumping = false;
          }

          if(this.isArrivingData)
          {
            this.x = this.targetX * 0.5 + this.x * 0.5;
            this.y = this.targetY * 0.5 + this.y * 0.5;
            this.isArrivingData = false;
          }
          else
          {
            this.x = this.targetX * 0.5 + this.x * 0.5;
            this.y = this.targetY * 0.5 + this.y * 0.5;
          }

          this.preX = this.x;
          this.preY = this.y;
        },
      });

      phina.define('Ball', {
        superClass: 'Sprite',
        init: function() {
          this.superInit('ball');
          this.width = 32;
          this.height = 32;

          this.preX = 0.0;
          this.preY = 0.0;

          this.targetX = 0.0;
          this.targetY = 0.0;
        },
        update: function(app)
        {
          this.x = this.targetX * 0.2 + this.x * 0.8;
          this.y = this.targetY * 0.2 + this.y * 0.8;

          this.preX = this.x;
          this.preY = this.y;
        },
      });

      /*
   * コンボラベル
   */
  phina.define('ComboLabel', {
    superClass: 'RectangleShape',
    init: function(text) {
      this.superInit();
      this.label = Label(text).addChildTo(this);
      this.label.fill = 'black';
      this.label.fontSize = 16;

      this.fill = 'white';
      this.width = this.label.fontSize * this.label.text.length + 10;
      this.height = this.label.fontSize * 2;
      this.stroke = "rgb(127, 127, 127)";
      this.strokeWidth = 1;
      this.cornerRadius = 8;

      // フェードアウトして削除
      this.tweener.set({
        alpha: 0,
        y: -20
      })
      .by({
        alpha: 1,
        y: -20
      }, 200).wait(4000)
        .by({
          alpha: -1
        })
        .call(function() {
          this.remove();
        }, this);
    },
  });

    phina.main(function() {
      var app = GameApp({
        startLabel: 'main',
        assets: ASSETS,
        width: 640,
        height: 480
      });

      app.fps = 30;
      app.run();
    });
